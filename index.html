<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Play Chess</title>
<script src="./socket.io/socket.io.js"></script>
<script type="module" src="./src/ui/HTMLChessBoardElement.js"></script>
</head>
<body>
<link rel="stylesheet" type="text/css" href="./all.css">
<main>
	<chess-board id="chessBoard" labels></chess-board>
	<div id="chessHistory"></div>
</main>
<style type="text/css">

#chessBoard {
	width: 100%;
	font-family: 'Consolas', 'Roboto mono', monospace;
}

</style>
<script type="module">

import { Game, MoveCapture, HTMLChessBoardElement } from './index.js';

localStorage.token = localStorage.token || randomString(16);
const userId = localStorage.token.slice(0, 8);
let playWhite = null;

const socket = io('/', {
	query: {
		token: localStorage.token,
	},
});
socket.call = function (funcName, ...args) {
	return new Promise((resolve, reject) => {
		this.emit(funcName, ...args, function (res, err) {
			if (err) {
				reject(err);
			}
			else {
				resolve(res);
			}
		});
	});
};
let game;

const params = new URLSearchParams(document.location.search);
const gameId = params.get('gameId');
if (!gameId) {
	params.set('gameId', randomString(16));
	document.location.href = new URL('?' + params, document.location.href).toString();
}

socket.on('joined', (meta) => console.log('joined', meta));

socket.on('connect', () => {
	socket.emit('joinGame', gameId, async (err, pgn) => {
		game = window.game = await Game.parsePgn(pgn);
		const lastMove = await game.seekToEnd();
		redrawChessBoard();
		if (game.meta.White === userId) {
			playWhite = true;
		}
		else if (game.meta.Black === userId) {
			playWhite = false;
		}
		chessBoard.swap = playWhite === false;
	});
});

socket.on('applyMove', (gameId, moveAbbr) => {
	if (game.meta.Id !== gameId) {
		return;
	}
	console.log('applyMove', moveAbbr);
	const move = game.applyMove(moveAbbr);
	redrawChessBoard(move);
});

let selected = null;
async function onChessClick(event) {
	if (playWhite === null || playWhite != game.activeWhite) {
		return;
	}
	const coord = event.detail.coord;
	const piece = game.get(coord);
	
	if (selected) {
		if (coord.txt === selected.coord.txt) {
			chessBoard.dots = '';
			selected = null;
			return;
		}
		else if (piece && piece.isWhite === selected.piece.isWhite) {
			chessBoard.dots = '';
			selected = null;
			return await onChessClick.call(this, event);
		}
		else {
			const moveAbbr = selected.coord.txt + coord.txt;
			// const move = game.applyMove(moveAbbr);
			// chessBoard.applyMove(moveAbbr);
			// chessBoard.dots = '';
			// chessBoard.arrows = HTMLChessBoardElement.generateArrows(move, game);
			
			await new Promise((resolve, reject) => {
				socket.emit('applyMove', game.meta.Id, moveAbbr, (err, moveAbbr) => {
					if (err) {
						return reject(new Error(err));
					}
					const move = game.applyMove(moveAbbr);
					redrawChessBoard(move);
					resolve(move);
				});
			});
			selected = null;
		}
	}
	else if (piece && piece.isWhite === game.activeWhite) {
		const moveDots = HTMLChessBoardElement.generateMoveDots(chessBoard.state, coord);
		chessBoard.dots = moveDots.join(' ');
		if (moveDots.length) {
			selected = { piece, coord };
		}
	}
}
chessBoard.addEventListener('chessClick', onChessClick);

function redrawChessBoard(moveToApply) {
	if (moveToApply) {
		try {
			moveToApply = chessBoard.applyMove(moveToApply);
		}
		catch {
			moveToApply = null;
		}
	}
	
	if (!moveToApply) {
		chessBoard.state = game.toFen();
	}
	
	chessBoard.dots = '';
	chessBoard.arrows = HTMLChessBoardElement.generateArrows(game.getCurrentMove(), game);
	return moveToApply;
}

function randomString(len) {
	const c = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
	let res = '';
	while (res.length < len) {
		res += c[Math.round(Math.random() * c.length) % c.length];
	}
	return res;
}

</script>
</body>
</html>